# Astro å®¹å™¨å³æœåŠ¡å¹³å° - æ¶æ„è®¾è®¡æ–‡æ¡£

> ç‰ˆæœ¬ï¼šv1.0
> æ—¥æœŸï¼š2025-12-11
> çŠ¶æ€ï¼šè®¾è®¡é˜¶æ®µ

---

## æ–‡æ¡£ç›®å½•

1. [é¡¹ç›®æ¦‚è¿°](#1-é¡¹ç›®æ¦‚è¿°)
2. [æ¶æ„è®¾è®¡](#2-æ¶æ„è®¾è®¡)
3. [æŠ€æœ¯é€‰å‹](#3-æŠ€æœ¯é€‰å‹)
4. [æ¨¡å—è®¾è®¡](#4-æ¨¡å—è®¾è®¡)
5. [æ¥å£è®¾è®¡](#5-æ¥å£è®¾è®¡)
6. [æ•°æ®æ¨¡å‹](#6-æ•°æ®æ¨¡å‹)
7. [éƒ¨ç½²æ–¹æ¡ˆ](#7-éƒ¨ç½²æ–¹æ¡ˆ)
8. [å®‰å…¨è®¾è®¡](#8-å®‰å…¨è®¾è®¡)
9. [ç›‘æ§ä¸è¿ç»´](#9-ç›‘æ§ä¸è¿ç»´)
10. [é£é™©ä¸æŒ‘æˆ˜](#10-é£é™©ä¸æŒ‘æˆ˜)

---

## 1. é¡¹ç›®æ¦‚è¿°

### 1.1 é¡¹ç›®å®šä½

Astro æ˜¯ä¸€ä¸ªé¢å‘ C ç«¯ç”¨æˆ·çš„å®¹å™¨å³æœåŠ¡ï¼ˆCaaSï¼‰å¹³å°ï¼Œç›®æ ‡æ˜¯ï¼š
- **é™ä½å®¹å™¨æŠ€æœ¯ä½¿ç”¨é—¨æ§›**ï¼šè®©éæŠ€æœ¯ç”¨æˆ·ä¹Ÿèƒ½è½»æ¾éƒ¨ç½²å®¹å™¨åŒ–åº”ç”¨
- **ç®€åŒ–è¿ç»´å¤æ‚åº¦**ï¼šæä¾›ä¸€é”®éƒ¨ç½²ã€è‡ªåŠ¨åŒ–ç®¡ç†
- **å¼€ç®±å³ç”¨**ï¼šé¢„ç½®å¸¸ç”¨åº”ç”¨æ¨¡æ¿ï¼ˆMySQLã€Redisã€Nginx ç­‰ï¼‰

### 1.2 ç›®æ ‡ç”¨æˆ·

- ä¸ªäººå¼€å‘è€…å’ŒæŠ€æœ¯çˆ±å¥½è€…
- å°å‹åˆ›ä¸šå›¢é˜Ÿï¼ˆ<10 äººï¼‰
- éœ€è¦å¿«é€ŸéªŒè¯æƒ³æ³•çš„äº§å“ç»ç†
- å­¦ä¹ å®¹å™¨æŠ€æœ¯çš„åˆå­¦è€…

### 1.3 æ ¸å¿ƒä»·å€¼

| ä¼ ç»Ÿæ–¹å¼ | Astro æ–¹æ¡ˆ |
|---------|-----------|
| éœ€è¦ç¼–å†™å¤æ‚çš„ YAML | Web ç•Œé¢å¡«å‡ ä¸ªå‚æ•° |
| ç†è§£ Pod/Deployment/Service | åªéœ€æ‡‚"éƒ¨ç½²åº”ç”¨" |
| æ‰‹åŠ¨ç®¡ç†å®¹å™¨ç”Ÿå‘½å‘¨æœŸ | ä¸€é”®å¯åœã€é‡å¯ã€åˆ é™¤ |
| æŸ¥çœ‹æ—¥å¿—éœ€è¦ kubectl | æµè§ˆå™¨ä¸­ç›´æ¥æŸ¥çœ‹ |

### 1.4 MVP åŠŸèƒ½èŒƒå›´

**ç¬¬ä¸€é˜¶æ®µï¼ˆå½“å‰è®¾è®¡ï¼‰** - å®ç°è¿›åº¦ï¼šâœ… å·²å®Œæˆ
- âœ… ç”¨æˆ·æ³¨å†Œ/ç™»å½•/JWT è®¤è¯
- âœ… åº”ç”¨åˆ›å»º/åˆ é™¤
- âœ… åº”ç”¨å¯åŠ¨/åœæ­¢/é‡å¯
- âœ… åº”ç”¨æ—¥å¿—æŸ¥çœ‹
- âœ… å¤šç§Ÿæˆ·éš”ç¦»ï¼ˆæ¯ä¸ªç”¨æˆ·ç‹¬ç«‹å‘½åç©ºé—´ï¼‰

**ç¬¬äºŒé˜¶æ®µï¼ˆæœªæ¥æ‰©å±•ï¼‰** - çŠ¶æ€ï¼šğŸ”„ è§„åˆ’ä¸­
- ğŸ”„ åº”ç”¨æ¨¡æ¿å¸‚åœº
- ğŸ”„ èµ„æºç›‘æ§ï¼ˆCPU/å†…å­˜ï¼‰
- ğŸ”„ è‡ªåŠ¨æ‰©ç¼©å®¹
- ğŸ”„ æŒä¹…åŒ–å­˜å‚¨ç®¡ç†
- ğŸ”„ åŸŸåç»‘å®šå’Œè¯ä¹¦ç®¡ç†

---

## 1.5 å¼€å‘è¿›åº¦ TODO

> æœ€åæ›´æ–°ï¼š2025-12-11

### åŸºç¡€è®¾æ–½å±‚ âœ… å·²å®Œæˆ
- [x] `pkg/config` - é…ç½®åŠ è½½ï¼ˆViperï¼‰
- [x] `pkg/logger` - æ—¥å¿—ç³»ç»Ÿï¼ˆZap + æ—¥å¿—è½®è½¬ï¼‰
- [x] `pkg/errcode` - é”™è¯¯ç å®šä¹‰
- [x] `internal/k8s/client.go` - K8s å®¢æˆ·ç«¯åˆå§‹åŒ–
- [x] `cmd/server/main.go` - æœåŠ¡å¯åŠ¨å…¥å£

### ç”¨æˆ·æ¨¡å— âœ… å·²å®Œæˆ
- [x] `internal/model/model.go` - User æ•°æ®æ¨¡å‹
- [x] `internal/repository/user.go` - UserRepository
- [x] `internal/service/user.go` - UserServiceï¼ˆæ³¨å†Œã€ç™»å½•ã€JWTï¼‰
- [x] `internal/handler/user.go` - UserHandlerï¼ˆRegisterã€Loginï¼‰
- [x] `internal/middleware/auth.go` - JWT è®¤è¯ä¸­é—´ä»¶

### åº”ç”¨æ¨¡å— âœ… å·²å®Œæˆ
- [x] `internal/model/model.go` - App æ•°æ®æ¨¡å‹
- [x] `internal/k8s/adapter.go` - K8s Adapter æ¥å£å’Œå®ç°
- [x] `internal/repository/app.go` - AppRepository
- [x] `internal/service/app.go` - AppServiceï¼ˆCRUDã€å¯åœã€æ—¥å¿—ï¼‰
- [x] `internal/handler/app.go` - AppHandlerï¼ˆ8 ä¸ª APIï¼‰

### å¾…å¼€å‘åŠŸèƒ½ ğŸ“‹ TODO
- [ ] å‰ç«¯ Web ç•Œé¢
- [ ] åº”ç”¨æ¨¡æ¿å¸‚åœºåŠŸèƒ½
- [ ] èµ„æºç›‘æ§ï¼ˆPrometheus é›†æˆï¼‰
- [ ] æŒä¹…åŒ–å­˜å‚¨ç®¡ç†ï¼ˆPVCï¼‰
- [ ] åŸŸåç»‘å®šå’Œ TLS è¯ä¹¦
- [ ] ç”¨æˆ·é‚®ç®±éªŒè¯
- [ ] åº”ç”¨é…é¢é™åˆ¶ï¼ˆResourceQuotaï¼‰
- [ ] ç½‘ç»œç­–ç•¥éš”ç¦»ï¼ˆNetworkPolicyï¼‰

---

## 2. æ¶æ„è®¾è®¡

### 2.1 æ€»ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          ç”¨æˆ·å±‚                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚  Web å‰ç«¯    â”‚  â”‚  ç§»åŠ¨ç«¯ Appï¼ˆä¸å®ç°ï¼‰ â”‚  â”‚  CLI å·¥å…·ï¼ˆä¸å®ç°ï¼‰ â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚         â”‚                  â”‚                  â”‚                  â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                            â”‚                                     â”‚
â”‚                            â”‚ HTTPS/REST API                      â”‚
â”‚                            â–¼                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Astro API æœåŠ¡å±‚                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Gin HTTP Server                                         â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚   â”‚
â”‚  â”‚  â”‚ Auth ä¸­é—´ä»¶â”‚  â”‚ Logger ä¸­é—´ä»¶â”‚ â”‚ CORS ä¸­é—´ä»¶â”‚       â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Handler å±‚ï¼ˆHTTP å¤„ç†å™¨ï¼‰                                â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚   â”‚
â”‚  â”‚  â”‚ UserHandler     â”‚  â”‚ AppHandler       â”‚              â”‚   â”‚
â”‚  â”‚  â”‚ - Register      â”‚  â”‚ - CreateApp      â”‚              â”‚   â”‚
â”‚  â”‚  â”‚ - Login         â”‚  â”‚ - DeleteApp      â”‚              â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ - Start/Stop     â”‚              â”‚   â”‚
â”‚  â”‚                       â”‚ - GetLogs        â”‚              â”‚   â”‚
â”‚  â”‚                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                            â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Service å±‚ï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰                                  â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚    â”‚
â”‚  â”‚  â”‚ UserService     â”‚  â”‚ AppService       â”‚            â”‚    â”‚
â”‚  â”‚  â”‚ - JWT ç”Ÿæˆ      â”‚  â”‚ - åº”ç”¨ç”Ÿå‘½å‘¨æœŸ   â”‚            â”‚    â”‚
â”‚  â”‚  â”‚ - å¯†ç åŠ å¯†      â”‚  â”‚ - çŠ¶æ€åŒæ­¥       â”‚            â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ - æƒé™æ£€æŸ¥       â”‚            â”‚    â”‚
â”‚  â”‚                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                            â”‚                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Repository å±‚ï¼ˆæ•°æ®è®¿é—®ï¼‰                               â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚    â”‚
â”‚  â”‚  â”‚ UserRepository  â”‚  â”‚ AppRepository    â”‚            â”‚    â”‚
â”‚  â”‚  â”‚ - CRUD          â”‚  â”‚ - CRUD           â”‚            â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                            â”‚                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                    â”‚                      â”‚
        â–¼                    â–¼                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MariaDB      â”‚  â”‚  K8s Adapter     â”‚  â”‚  Zap Logger     â”‚
â”‚  (GORM)       â”‚  â”‚  (æŠ½è±¡å±‚)        â”‚  â”‚  (æ—¥å¿—ç³»ç»Ÿ)      â”‚
â”‚               â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚           â”‚
â”‚  â”‚ users   â”‚  â”‚           â”‚
â”‚  â”‚ apps    â”‚  â”‚           â–¼
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  Kubernetes é›†ç¾¤                   â”‚
                   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                   â”‚  â”‚  Namespace: astro-user-1    â”‚  â”‚
                   â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
                   â”‚  â”‚  â”‚Deploymentâ”‚  â”‚ Service â”‚  â”‚  â”‚
                   â”‚  â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
                   â”‚  â”‚       â”‚                      â”‚  â”‚
                   â”‚  â”‚  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
                   â”‚  â”‚  â”‚ Pod 1   â”‚  â”‚ Pod 2   â”‚  â”‚  â”‚
                   â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
                   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                   â”‚  â”‚  Namespace: astro-user-2    â”‚  â”‚
                   â”‚  â”‚  ...                         â”‚  â”‚
                   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 åˆ†å±‚æ¶æ„è¯´æ˜

#### 2.2.1 Handler å±‚
**èŒè´£**ï¼š
- æ¥æ”¶ HTTP è¯·æ±‚ï¼Œè§£æå‚æ•°
- å‚æ•°æ ¡éªŒï¼ˆä½¿ç”¨ Gin çš„ bindingï¼‰
- è°ƒç”¨ Service å±‚
- æ ¼å¼åŒ–å“åº”ï¼ˆç»Ÿä¸€ Response ç»“æ„ï¼‰

**è®¾è®¡åŸåˆ™**ï¼š
- è½»è–„å±‚ï¼Œä¸åŒ…å«ä¸šåŠ¡é€»è¾‘
- åªåšå‚æ•°è½¬æ¢å’Œé”™è¯¯ç¿»è¯‘

#### 2.2.2 Service å±‚
**èŒè´£**ï¼š
- ä¸šåŠ¡é€»è¾‘å®ç°
- æƒé™æ£€æŸ¥
- äº‹åŠ¡ç®¡ç†
- è°ƒç”¨ Repository å’Œ K8s Adapter

**è®¾è®¡åŸåˆ™**ï¼š
- å•ä¸€èŒè´£ï¼šæ¯ä¸ª Service å¯¹åº”ä¸€ä¸ªä¸šåŠ¡é¢†åŸŸ
- å¯æµ‹è¯•ï¼šä¾èµ–æ³¨å…¥ï¼Œä¾¿äº Mock

#### 2.2.3 Repository å±‚
**èŒè´£**ï¼š
- æ•°æ®åº“ CRUD æ“ä½œ
- SQL æŸ¥è¯¢å°è£…

**è®¾è®¡åŸåˆ™**ï¼š
- çº¯æ•°æ®è®¿é—®ï¼Œä¸å«ä¸šåŠ¡é€»è¾‘
- è¿”å›é¢†åŸŸæ¨¡å‹ï¼ˆmodel.User, model.Appï¼‰

#### 2.2.4 K8s Adapter å±‚ï¼ˆå…³é”®è®¾è®¡ï¼‰
**èŒè´£**ï¼š
- å°è£… Kubernetes æ“ä½œ
- æä¾›ç»Ÿä¸€çš„æ¥å£æŠ½è±¡

**è®¾è®¡äº®ç‚¹**ï¼š
```go
type AppAdapter interface {
    CreateApp(ctx context.Context, spec AppSpec) error
    DeleteApp(ctx context.Context, name, namespace string) error
    ScaleApp(ctx context.Context, name, namespace string, replicas int32) error
    GetAppStatus(ctx context.Context, name, namespace string) (*AppStatus, error)
    RestartApp(ctx context.Context, name, namespace string) error
    GetAppLogs(ctx context.Context, name, namespace string, lines int64) (string, error)
}
```

**ä¼˜åŠ¿**ï¼š
1. **è§£è€¦**ï¼šService å±‚ä¸ä¾èµ–å…·ä½“çš„ K8s å®ç°
2. **å¯æ‰©å±•**ï¼šæœªæ¥å¯ä»¥æ— ç¼åˆ‡æ¢åˆ° Operator æ¨¡å¼
3. **å¯æµ‹è¯•**ï¼šå¯ä»¥ Mock Adapter è¿›è¡Œå•å…ƒæµ‹è¯•

### 2.3 æ¸è¿›å¼æ¼”è¿›è·¯çº¿

#### é˜¶æ®µ 1ï¼šclient-go ç›´æ¥è°ƒç”¨ï¼ˆå½“å‰æ–¹æ¡ˆï¼‰

```
Service â†’ ClientGoAdapter â†’ Kubernetes API
```

**ç‰¹ç‚¹**ï¼š
- ç®€å•ç›´æ¥ï¼Œå¼€å‘é€Ÿåº¦å¿«
- ä»£ç é‡ï¼š~300 è¡Œ
- é€‚ç”¨åœºæ™¯ï¼šMVP éªŒè¯ï¼Œç”¨æˆ·é‡ < 1000

#### é˜¶æ®µ 2ï¼šå¼•å…¥ Operatorï¼ˆå¯é€‰å‡çº§ï¼‰

```
Service â†’ OperatorAdapter â†’ è‡ªå®šä¹‰ CRD â†’ Operator Controller â†’ Kubernetes API
```

**è§¦å‘æ¡ä»¶**ï¼š
- ç”¨æˆ·é‡ > 100ï¼Œåº”ç”¨å®ä¾‹ > 500
- éœ€è¦æ”¯æŒ StatefulSetã€CronJob ç­‰å¤æ‚èµ„æº
- éœ€è¦è‡ªåŠ¨åŒ–è¿ç»´ï¼ˆå¤‡ä»½ã€å‡çº§ã€è‡ªæ„ˆï¼‰

**ä¼˜åŠ¿**ï¼š
- å£°æ˜å¼ç®¡ç†ï¼Œè‡ªåŠ¨è°ƒè°
- å¤æ‚ç”Ÿå‘½å‘¨æœŸç®¡ç†
- ç¬¦åˆ Kubernetes åŸç”Ÿç†å¿µ

---

## 3. æŠ€æœ¯é€‰å‹

### 3.1 åç«¯æŠ€æœ¯æ ˆ

| ç»„ä»¶ | æŠ€æœ¯é€‰å‹ | ç‰ˆæœ¬ | é€‰å‹ç†ç”± |
|------|---------|------|---------|
| ç¼–ç¨‹è¯­è¨€ | Go | 1.25+ | é«˜æ€§èƒ½ã€é™æ€ç±»å‹ã€K8s ç”Ÿæ€å‹å¥½ |
| Web æ¡†æ¶ | Gin | 1.9.1 | è½»é‡ã€é«˜æ€§èƒ½ã€æ–‡æ¡£å®Œå–„ |
| æ•°æ®åº“ | MariaDB | 10.6+ | å¼€æºã€å…¼å®¹ MySQLã€æ€§èƒ½ä¼˜ç§€ |
| ORM | GORM | 1.25.0 | åŠŸèƒ½å¼ºå¤§ã€è‡ªåŠ¨è¿ç§»ã€å…³è”æŸ¥è¯¢ |
| æ—¥å¿— | Zap | 1.26.0 | é«˜æ€§èƒ½ã€ç»“æ„åŒ–æ—¥å¿—ã€æ”¯æŒè½®è½¬ |
| é…ç½®ç®¡ç† | Viper | 1.17.0 | æ”¯æŒå¤šæ ¼å¼ã€ç¯å¢ƒå˜é‡ã€çƒ­æ›´æ–° |
| è®¤è¯ | JWT | golang-jwt/v5 | æ— çŠ¶æ€ã€è·¨åŸŸå‹å¥½ |
| å¯†ç åŠ å¯† | bcrypt | crypto/bcrypt | ä¸šç•Œæ ‡å‡†ã€é˜²å½©è™¹è¡¨ |
| K8s å®¢æˆ·ç«¯ | client-go | 0.28.0 | å®˜æ–¹åº“ã€åŠŸèƒ½å®Œæ•´ |

### 3.2 æŠ€æœ¯é€‰å‹å¯¹æ¯”

#### 3.2.1 ä¸ºä»€ä¹ˆé€‰ Gin è€Œä¸æ˜¯å…¶ä»–æ¡†æ¶ï¼Ÿ

| æ¡†æ¶ | æ€§èƒ½ | ç”Ÿæ€ | å­¦ä¹ æ›²çº¿ | ç»“è®º |
|------|-----|-----|---------|------|
| Gin | â­â­â­â­â­ | â­â­â­â­â­ | ä½ | âœ… é€‰æ‹© |
| Echo | â­â­â­â­â­ | â­â­â­â­ | ä½ | å¤‡é€‰ |
| Fiber | â­â­â­â­â­ | â­â­â­ | ä¸­ | ç”Ÿæ€ä¸å¦‚ Gin |
| Beego | â­â­â­ | â­â­â­â­ | é«˜ | è¿‡äºé‡é‡çº§ |

#### 3.2.2 ä¸ºä»€ä¹ˆç”¨ client-go è€Œä¸æ˜¯ç›´æ¥ HTTP è°ƒç”¨ K8s APIï¼Ÿ

| æ–¹æ¡ˆ | ä¼˜åŠ¿ | åŠ£åŠ¿ | ç»“è®º |
|------|-----|-----|------|
| client-go | ç±»å‹å®‰å…¨ã€è‡ªåŠ¨è®¤è¯ã€é‡è¯•æœºåˆ¶ | å­¦ä¹ æˆæœ¬é«˜ | âœ… é€‰æ‹© |
| HTTP API | ç®€å•ç›´æ¥ | éœ€è¦æ‰‹åŠ¨å¤„ç†è®¤è¯ã€åºåˆ—åŒ–ã€é”™è¯¯ | âŒ ä¸æ¨è |

---

## 4. æ¨¡å—è®¾è®¡

### 4.1 ç”¨æˆ·æ¨¡å—ï¼ˆUserï¼‰

#### 4.1.1 åŠŸèƒ½åˆ—è¡¨
- ç”¨æˆ·æ³¨å†Œï¼ˆç”¨æˆ·å/å¯†ç /é‚®ç®±ï¼‰
- ç”¨æˆ·ç™»å½•ï¼ˆè¿”å› JWT Tokenï¼‰
- ç”¨æˆ·ä¿¡æ¯æŸ¥è¯¢ï¼ˆæœªæ¥æ‰©å±•ï¼‰

#### 4.1.2 æ ¸å¿ƒæµç¨‹

**æ³¨å†Œæµç¨‹**ï¼š
```
1. Handler æ¥æ”¶è¯·æ±‚ï¼Œå‚æ•°æ ¡éªŒ
   â†“
2. Service æ£€æŸ¥ç”¨æˆ·å/é‚®ç®±æ˜¯å¦é‡å¤
   â†“
3. bcrypt åŠ å¯†å¯†ç 
   â†“
4. Repository å†™å…¥æ•°æ®åº“
   â†“
5. è¿”å›æˆåŠŸå“åº”
```

**ç™»å½•æµç¨‹**ï¼š
```
1. Handler æ¥æ”¶ç”¨æˆ·å/å¯†ç 
   â†“
2. Service æŸ¥è¯¢ç”¨æˆ·
   â†“
3. bcrypt éªŒè¯å¯†ç 
   â†“
4. ç”Ÿæˆ JWT Tokenï¼ˆæœ‰æ•ˆæœŸ 24hï¼‰
   â†“
5. è¿”å› Token å’Œ User UUID
```

#### 4.1.3 å®‰å…¨è®¾è®¡
- å¯†ç ä½¿ç”¨ bcrypt åŠ å¯†ï¼ˆcost=10ï¼‰
- JWT ç­¾åä½¿ç”¨ HMAC-SHA256
- Token åŒ…å« user_id å’Œ expï¼ˆè¿‡æœŸæ—¶é—´ï¼‰
- ç™»å½•å¤±è´¥ä¸åŒºåˆ†"ç”¨æˆ·ä¸å­˜åœ¨"å’Œ"å¯†ç é”™è¯¯"ï¼ˆé˜²ä¿¡æ¯æ³„éœ²ï¼‰

### 4.2 åº”ç”¨æ¨¡å—ï¼ˆAppï¼‰

#### 4.2.1 åŠŸèƒ½åˆ—è¡¨
- åˆ›å»ºåº”ç”¨ï¼ˆæŒ‡å®šé•œåƒã€å‰¯æœ¬æ•°ã€ç«¯å£ï¼‰
- åˆ é™¤åº”ç”¨
- å¯åŠ¨åº”ç”¨ï¼ˆScale to Nï¼‰
- åœæ­¢åº”ç”¨ï¼ˆScale to 0ï¼‰
- é‡å¯åº”ç”¨ï¼ˆRolling Restartï¼‰
- æŸ¥çœ‹åº”ç”¨åˆ—è¡¨
- æŸ¥çœ‹åº”ç”¨è¯¦æƒ…ï¼ˆåŒ…å« Pod çŠ¶æ€ï¼‰
- æŸ¥çœ‹åº”ç”¨æ—¥å¿—

#### 4.2.2 æ ¸å¿ƒæµç¨‹

**åˆ›å»ºåº”ç”¨æµç¨‹**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. Handler æ¥æ”¶è¯·æ±‚                                         â”‚
â”‚     - name: "my-app"                                        â”‚
â”‚     - image: "nginx:latest"                                 â”‚
â”‚     - replicas: 2                                           â”‚
â”‚     - port: 80                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. Service å±‚å¤„ç†                                           â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚     â”‚ 2.1 æ£€æŸ¥ K8s å®¢æˆ·ç«¯æ˜¯å¦å¯ç”¨                      â”‚     â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                  â”‚                                           â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚     â”‚ 2.2 æ£€æŸ¥åº”ç”¨åæ˜¯å¦é‡å¤ï¼ˆåŒä¸€ç”¨æˆ·ä¸‹ï¼‰            â”‚     â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                  â”‚                                           â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚     â”‚ 2.3 æ„å»ºå‘½åç©ºé—´: astro-user-{user_id}          â”‚     â”‚
â”‚     â”‚     æ„å»º K8s åç§°: {app_name}-u{user_id}         â”‚     â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                  â”‚                                           â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚     â”‚ 2.4 å†™å…¥æ•°æ®åº“ï¼ˆstatus=pendingï¼‰                 â”‚     â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                  â”‚                                           â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚     â”‚ 2.5 è°ƒç”¨ Adapter.CreateApp()                     â”‚     â”‚
â”‚     â”‚     - åˆ›å»º Deployment                            â”‚     â”‚
â”‚     â”‚     - åˆ›å»º Serviceï¼ˆå¦‚æœæœ‰ç«¯å£ï¼‰                 â”‚     â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                  â”‚                                           â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚     â”‚ 2.6 å¼‚æ­¥åŒæ­¥çŠ¶æ€ï¼ˆGoroutineï¼‰                    â”‚     â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. K8s Adapter æ‰§è¡Œ                                         â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚     â”‚ 3.1 æ„å»º Deployment YAML                         â”‚     â”‚
â”‚     â”‚     - metadata: name, namespace, labels         â”‚     â”‚
â”‚     â”‚     - spec: replicas, selector, template        â”‚     â”‚
â”‚     â”‚     - container: image, ports, resources        â”‚     â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                  â”‚                                           â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚     â”‚ 3.2 è°ƒç”¨ K8s API: CreateDeployment()            â”‚     â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                  â”‚                                           â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚     â”‚ 3.3 æ„å»º Service YAMLï¼ˆå¦‚æœæœ‰ç«¯å£ï¼‰             â”‚     â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                  â”‚                                           â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚     â”‚ 3.4 è°ƒç”¨ K8s API: CreateService()               â”‚     â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. K8s é›†ç¾¤æ‰§è¡Œ                                             â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚     â”‚ 4.1 Scheduler è°ƒåº¦ Pod åˆ°èŠ‚ç‚¹                    â”‚     â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                  â”‚                                           â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚     â”‚ 4.2 Kubelet æ‹‰å–é•œåƒå¹¶å¯åŠ¨å®¹å™¨                   â”‚     â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                  â”‚                                           â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚     â”‚ 4.3 Readiness Probe æ£€æŸ¥å®¹å™¨çŠ¶æ€                 â”‚     â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                  â”‚                                           â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚     â”‚ 4.4 Service æ›´æ–° Endpoints                       â”‚     â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. çŠ¶æ€åŒæ­¥ï¼ˆå¼‚æ­¥ï¼‰                                         â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚     â”‚ 5.1 Adapter.GetAppStatus()                       â”‚     â”‚
â”‚     â”‚     - æŸ¥è¯¢ Deployment.Status                     â”‚     â”‚
â”‚     â”‚     - æŸ¥è¯¢ Pod åˆ—è¡¨                              â”‚     â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                  â”‚                                           â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚     â”‚ 5.2 æ›´æ–°æ•°æ®åº“                                   â”‚     â”‚
â”‚     â”‚     - status: "Running" / "Pending" / "Failed"  â”‚     â”‚
â”‚     â”‚     - replicas: å®é™…å‰¯æœ¬æ•°                       â”‚     â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4.2.3 å¤šç§Ÿæˆ·éš”ç¦»è®¾è®¡

**å‘½åç©ºé—´ç­–ç•¥**ï¼š
- æ¯ä¸ªç”¨æˆ·åˆ†é…ç‹¬ç«‹å‘½åç©ºé—´ï¼š`astro-user-{user_id}`
- ä¾‹å¦‚ï¼šç”¨æˆ· ID ä¸º 123 â†’ å‘½åç©ºé—´ `astro-user-123`

**èµ„æºå‘½åç­–ç•¥**ï¼š
- åº”ç”¨åæ ¼å¼ï¼š`{app_name}-u{user_id}`
- ä¾‹å¦‚ï¼šç”¨æˆ· 123 åˆ›å»º "nginx" â†’ K8s èµ„æºå `nginx-u123`

**å¥½å¤„**ï¼š
- âœ… é¿å…å‘½åå†²çªï¼ˆä¸åŒç”¨æˆ·å¯ä»¥åˆ›å»ºåŒååº”ç”¨ï¼‰
- âœ… èµ„æºéš”ç¦»ï¼ˆç½‘ç»œç­–ç•¥ã€èµ„æºé…é¢ï¼‰
- âœ… ä¾¿äºæ¸…ç†ï¼ˆåˆ é™¤ç”¨æˆ·æ—¶ç›´æ¥åˆ é™¤å‘½åç©ºé—´ï¼‰

#### 4.2.4 çŠ¶æ€åŒæ­¥æœºåˆ¶

**åŒæ­¥ç­–ç•¥**ï¼š
```go
// åˆ›å»ºåº”ç”¨åç«‹å³å¼‚æ­¥åŒæ­¥ä¸€æ¬¡
go syncAppStatus(app.ID)

// æŸ¥è¯¢åº”ç”¨åˆ—è¡¨æ—¶å¼‚æ­¥åŒæ­¥æ‰€æœ‰åº”ç”¨
for _, app := range apps {
    go syncAppStatus(app.ID)
}

// æŸ¥è¯¢å•ä¸ªåº”ç”¨æ—¶åŒæ­¥ç­‰å¾…
syncAppStatus(app.ID)
app = repo.GetAppByID(app.ID) // é‡æ–°æŸ¥è¯¢
```

**çŠ¶æ€å®šä¹‰**ï¼š
| çŠ¶æ€ | å«ä¹‰ | è§¦å‘æ¡ä»¶ |
|-----|------|---------|
| pending | ç­‰å¾…ä¸­ | åˆšåˆ›å»ºï¼ŒPod æœªå°±ç»ª |
| running | è¿è¡Œä¸­ | ReadyReplicas == Replicas |
| stopped | å·²åœæ­¢ | Replicas == 0 |
| starting | å¯åŠ¨ä¸­ | æ­£åœ¨æ‰©å®¹ |
| restarting | é‡å¯ä¸­ | è§¦å‘äº†æ»šåŠ¨æ›´æ–° |
| unknown | æœªçŸ¥ | K8s æŸ¥è¯¢å¤±è´¥ |

---

## 5. æ¥å£è®¾è®¡

### 5.1 RESTful API è§„èŒƒ

**åŸºç¡€è§„èŒƒ**ï¼š
- åŸºç¡€è·¯å¾„ï¼š`/api/v1`
- è¯·æ±‚æ ¼å¼ï¼š`Content-Type: application/json`
- å“åº”æ ¼å¼ï¼šç»Ÿä¸€çš„ Response ç»“æ„

**ç»Ÿä¸€å“åº”ç»“æ„**ï¼š
```json
{
  "code": 0,              // é”™è¯¯ç ï¼Œ0 è¡¨ç¤ºæˆåŠŸ
  "message": "æˆåŠŸ",      // æ¶ˆæ¯æè¿°
  "data": {}             // ä¸šåŠ¡æ•°æ®ï¼ˆå¯é€‰ï¼‰
}
```

### 5.2 ç”¨æˆ·ç›¸å…³æ¥å£

#### 5.2.1 ç”¨æˆ·æ³¨å†Œ

```
POST /api/v1/register
```

**è¯·æ±‚å‚æ•°**ï¼š
```json
{
  "username": "johndoe",        // å¿…å¡«ï¼Œ3-20 å­—ç¬¦
  "password": "password123",    // å¿…å¡«ï¼Œ6-30 å­—ç¬¦
  "email": "john@example.com"   // å¿…å¡«ï¼Œé‚®ç®±æ ¼å¼
}
```

**æˆåŠŸå“åº”**ï¼š
```json
{
  "code": 0,
  "message": "æ³¨å†ŒæˆåŠŸ",
  "data": null
}
```

**é”™è¯¯å“åº”**ï¼š
```json
{
  "code": 20001,
  "message": "ç”¨æˆ·å·²å­˜åœ¨"
}
```

#### 5.2.2 ç”¨æˆ·ç™»å½•

```
POST /api/v1/login
```

**è¯·æ±‚å‚æ•°**ï¼š
```json
{
  "username": "johndoe",
  "password": "password123"
}
```

**æˆåŠŸå“åº”**ï¼š
```json
{
  "code": 0,
  "message": "ç™»å½•æˆåŠŸ",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "uuid": "550e8400-e29b-41d4-a716-446655440000"
  }
}
```

### 5.3 åº”ç”¨ç›¸å…³æ¥å£

#### 5.3.1 åˆ›å»ºåº”ç”¨

```
POST /api/v1/apps
Authorization: Bearer {token}
```

**è¯·æ±‚å‚æ•°**ï¼š
```json
{
  "name": "my-nginx",          // å¿…å¡«ï¼Œåº”ç”¨åç§°
  "image": "nginx:latest",     // å¿…å¡«ï¼Œé•œåƒåœ°å€
  "replicas": 2,               // å¿…å¡«ï¼Œå‰¯æœ¬æ•°ï¼ˆ0-10ï¼‰
  "port": 80                   // å¯é€‰ï¼Œå®¹å™¨ç«¯å£ï¼ˆ0è¡¨ç¤ºä¸æš´éœ²ï¼‰
}
```

**æˆåŠŸå“åº”**ï¼š
```json
{
  "code": 0,
  "message": "åˆ›å»ºæˆåŠŸ",
  "data": {
    "id": 1,
    "name": "my-nginx",
    "image": "nginx:latest",
    "replicas": 2,
    "status": "pending",
    "user_id": 123,
    "namespace": "astro-user-123",
    "created_at": "2025-12-11T10:00:00Z",
    "updated_at": "2025-12-11T10:00:00Z"
  }
}
```

#### 5.3.2 æŸ¥çœ‹åº”ç”¨åˆ—è¡¨

```
GET /api/v1/apps
Authorization: Bearer {token}
```

**æˆåŠŸå“åº”**ï¼š
```json
{
  "code": 0,
  "message": "æˆåŠŸ",
  "data": [
    {
      "id": 1,
      "name": "my-nginx",
      "image": "nginx:latest",
      "replicas": 2,
      "status": "running",
      "user_id": 123,
      "namespace": "astro-user-123",
      "created_at": "2025-12-11T10:00:00Z",
      "updated_at": "2025-12-11T10:05:00Z"
    }
  ]
}
```

#### 5.3.3 æŸ¥çœ‹åº”ç”¨è¯¦æƒ…

```
GET /api/v1/apps/{id}
Authorization: Bearer {token}
```

**æˆåŠŸå“åº”**ï¼š
```json
{
  "code": 0,
  "message": "æˆåŠŸ",
  "data": {
    "id": 1,
    "name": "my-nginx",
    "image": "nginx:latest",
    "replicas": 2,
    "status": "running",
    "user_id": 123,
    "namespace": "astro-user-123",
    "created_at": "2025-12-11T10:00:00Z",
    "updated_at": "2025-12-11T10:05:00Z"
  }
}
```

#### 5.3.4 åœæ­¢åº”ç”¨

```
POST /api/v1/apps/{id}/stop
Authorization: Bearer {token}
```

**æˆåŠŸå“åº”**ï¼š
```json
{
  "code": 0,
  "message": "åœæ­¢æˆåŠŸ",
  "data": null
}
```

#### 5.3.5 å¯åŠ¨åº”ç”¨

```
POST /api/v1/apps/{id}/start
Authorization: Bearer {token}
```

#### 5.3.6 é‡å¯åº”ç”¨

```
POST /api/v1/apps/{id}/restart
Authorization: Bearer {token}
```

#### 5.3.7 åˆ é™¤åº”ç”¨

```
DELETE /api/v1/apps/{id}
Authorization: Bearer {token}
```

#### 5.3.8 æŸ¥çœ‹åº”ç”¨æ—¥å¿—

```
GET /api/v1/apps/{id}/logs?lines=100
Authorization: Bearer {token}
```

**æŸ¥è¯¢å‚æ•°**ï¼š
- `lines`: æ—¥å¿—è¡Œæ•°ï¼ˆé»˜è®¤ 100ï¼‰

**æˆåŠŸå“åº”**ï¼š
```json
{
  "code": 0,
  "message": "æˆåŠŸ",
  "data": {
    "logs": "2025-12-11 10:00:00 [INFO] Server started\n2025-12-11 10:00:01 [INFO] Ready to accept connections\n..."
  }
}
```

### 5.4 é”™è¯¯ç å®šä¹‰

| é”™è¯¯ç  | å«ä¹‰ | HTTP çŠ¶æ€ç  |
|-------|------|-----------|
| 0 | æˆåŠŸ | 200 |
| 10001 | è¯·æ±‚å‚æ•°é”™è¯¯ | 200 |
| 10002 | æœªç™»å½•æˆ– Token æ— æ•ˆ | 200 |
| 10003 | æ— æƒé™è®¿é—® | 200 |
| 20001 | ç”¨æˆ·å·²å­˜åœ¨ | 200 |
| 20009 | ç™»å½•å¤±è´¥ | 200 |
| 21001 | åº”ç”¨ä¸å­˜åœ¨ | 200 |
| 21002 | åº”ç”¨å·²å­˜åœ¨ | 200 |
| 21003 | åˆ›å»ºåº”ç”¨å¤±è´¥ | 200 |
| 30001 | æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ | 200 |
| 30002 | æ•°æ®åº“é”™è¯¯ | 200 |
| 30003 | K8s æ“ä½œé”™è¯¯ | 200 |
| 30004 | K8s è¿æ¥å¤±è´¥ | 200 |

**æ³¨æ„**ï¼šæ‰€æœ‰é”™è¯¯éƒ½è¿”å› HTTP 200ï¼Œé€šè¿‡ `code` å­—æ®µåŒºåˆ†æˆåŠŸ/å¤±è´¥ã€‚

---

## 6. æ•°æ®æ¨¡å‹

### 6.1 ç”¨æˆ·è¡¨ï¼ˆusersï¼‰

```sql
CREATE TABLE users (
  id            INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  uuid          CHAR(36) UNIQUE NOT NULL COMMENT 'UUID',
  username      VARCHAR(64) UNIQUE NOT NULL COMMENT 'ç”¨æˆ·å',
  password      VARCHAR(128) NOT NULL COMMENT 'å¯†ç ï¼ˆbcryptåŠ å¯†ï¼‰',
  email         VARCHAR(128) UNIQUE COMMENT 'é‚®ç®±',
  status        TINYINT DEFAULT 1 COMMENT 'çŠ¶æ€ï¼š1-æ­£å¸¸ï¼Œ0-ç¦ç”¨',
  created_at    DATETIME NOT NULL COMMENT 'åˆ›å»ºæ—¶é—´',
  updated_at    DATETIME NOT NULL COMMENT 'æ›´æ–°æ—¶é—´',
  deleted_at    DATETIME COMMENT 'åˆ é™¤æ—¶é—´ï¼ˆè½¯åˆ é™¤ï¼‰',

  INDEX idx_username (username),
  INDEX idx_email (email),
  INDEX idx_uuid (uuid)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç”¨æˆ·è¡¨';
```

**å­—æ®µè¯´æ˜**ï¼š
- `uuid`: å¯¹å¤–æš´éœ²çš„ç”¨æˆ·æ ‡è¯†ï¼ˆé˜²æ­¢ ID æ³„éœ²ï¼‰
- `password`: bcrypt åŠ å¯†åçš„å¯†ç ï¼ˆ60 å­—ç¬¦ï¼‰
- `deleted_at`: è½¯åˆ é™¤æ ‡è®°ï¼ˆGORM è‡ªåŠ¨å¤„ç†ï¼‰

### 6.2 åº”ç”¨è¡¨ï¼ˆappsï¼‰

```sql
CREATE TABLE apps (
  id            INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  name          VARCHAR(64) NOT NULL COMMENT 'åº”ç”¨åç§°',
  image         VARCHAR(256) NOT NULL COMMENT 'é•œåƒåœ°å€',
  replicas      INT DEFAULT 1 COMMENT 'å‰¯æœ¬æ•°',
  status        VARCHAR(32) DEFAULT 'stopped' COMMENT 'çŠ¶æ€ï¼špending/running/stopped/starting/restarting/unknown',
  user_id       INT UNSIGNED NOT NULL COMMENT 'æ‰€å±ç”¨æˆ·ID',
  namespace     VARCHAR(64) NOT NULL COMMENT 'K8så‘½åç©ºé—´',
  created_at    DATETIME NOT NULL COMMENT 'åˆ›å»ºæ—¶é—´',
  updated_at    DATETIME NOT NULL COMMENT 'æ›´æ–°æ—¶é—´',
  deleted_at    DATETIME COMMENT 'åˆ é™¤æ—¶é—´ï¼ˆè½¯åˆ é™¤ï¼‰',

  INDEX idx_user_id (user_id),
  INDEX idx_name (name),
  INDEX idx_status (status),
  UNIQUE KEY uk_user_name (user_id, name, deleted_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='åº”ç”¨è¡¨';
```

**å­—æ®µè¯´æ˜**ï¼š
- `namespace`: å­˜å‚¨ K8s å‘½åç©ºé—´ï¼Œä¾¿äºæŸ¥è¯¢
- `uk_user_name`: åŒä¸€ç”¨æˆ·ä¸‹åº”ç”¨åå”¯ä¸€ï¼ˆè½¯åˆ é™¤åå¯ä»¥é‡ç”¨ï¼‰

### 6.3 ER å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      users        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)           â”‚
â”‚ uuid (UK)         â”‚
â”‚ username (UK)     â”‚
â”‚ password          â”‚
â”‚ email (UK)        â”‚
â”‚ status            â”‚
â”‚ created_at        â”‚
â”‚ updated_at        â”‚
â”‚ deleted_at        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚ 1
          â”‚
          â”‚ has many
          â”‚
          â”‚ N
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      apps         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)           â”‚
â”‚ name              â”‚
â”‚ image             â”‚
â”‚ replicas          â”‚
â”‚ status            â”‚
â”‚ user_id (FK)      â”‚
â”‚ namespace         â”‚
â”‚ created_at        â”‚
â”‚ updated_at        â”‚
â”‚ deleted_at        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. éƒ¨ç½²æ–¹æ¡ˆ

### 7.1 éƒ¨ç½²æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Kubernetes é›†ç¾¤                         â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Namespace: astro-system                               â”‚  â”‚
â”‚  â”‚                                                         â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  Astro API           â”‚  â”‚  MariaDB              â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  Deployment          â”‚  â”‚  StatefulSet          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - replicas: 3       â”‚  â”‚  - replicas: 1        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - HPA enabled       â”‚  â”‚  - PV: 20GB           â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚             â”‚                                          â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚  â”‚
â”‚  â”‚  â”‚  Service             â”‚                             â”‚  â”‚
â”‚  â”‚  â”‚  Type: ClusterIP     â”‚                             â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                â”‚                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Ingress Controller (Nginx)                            â”‚  â”‚
â”‚  â”‚  - TLS è¯ä¹¦                                             â”‚  â”‚
â”‚  â”‚  - è·¯ç”±è§„åˆ™: api.astro.com â†’ astro-api                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                â”‚                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â”‚ HTTPS
                 â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   Internet    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 èµ„æºé…ç½®

#### 7.2.1 Astro API Deployment

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: astro-api
  namespace: astro-system
spec:
  replicas: 3
  selector:
    matchLabels:
      app: astro-api
  template:
    metadata:
      labels:
        app: astro-api
    spec:
      serviceAccountName: astro-api
      containers:
      - name: api
        image: astro/api:v1.0.0
        ports:
        - containerPort: 8080
        env:
        - name: DB_HOST
          value: mariadb.astro-system.svc
        - name: DB_PORT
          value: "3306"
        - name: DB_USER
          valueFrom:
            secretKeyRef:
              name: db-secret
              key: username
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: db-secret
              key: password
        resources:
          requests:
            memory: "256Mi"
            cpu: "200m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 5
```

#### 7.2.2 MariaDB StatefulSet

```yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mariadb
  namespace: astro-system
spec:
  serviceName: mariadb
  replicas: 1
  selector:
    matchLabels:
      app: mariadb
  template:
    metadata:
      labels:
        app: mariadb
    spec:
      containers:
      - name: mariadb
        image: mariadb:10.6
        ports:
        - containerPort: 3306
        env:
        - name: MYSQL_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: db-secret
              key: root-password
        - name: MYSQL_DATABASE
          value: astro
        volumeMounts:
        - name: data
          mountPath: /var/lib/mysql
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "1Gi"
            cpu: "1000m"
  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      accessModes: [ "ReadWriteOnce" ]
      resources:
        requests:
          storage: 20Gi
```

### 7.3 RBAC é…ç½®

```yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: astro-api
  namespace: astro-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: astro-api-role
rules:
# ç®¡ç† Deployment
- apiGroups: ["apps"]
  resources: ["deployments", "deployments/scale"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
# ç®¡ç† Service
- apiGroups: [""]
  resources: ["services"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
# æŸ¥çœ‹ Pods
- apiGroups: [""]
  resources: ["pods", "pods/log"]
  verbs: ["get", "list", "watch"]
# ç®¡ç†å‘½åç©ºé—´
- apiGroups: [""]
  resources: ["namespaces"]
  verbs: ["get", "list", "create", "delete"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: astro-api-binding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: astro-api-role
subjects:
- kind: ServiceAccount
  name: astro-api
  namespace: astro-system
```

---

## 8. å®‰å…¨è®¾è®¡

### 8.1 è®¤è¯ä¸æˆæƒ

#### 8.1.1 JWT è®¤è¯æµç¨‹

```
1. ç”¨æˆ·ç™»å½• â†’ éªŒè¯ç”¨æˆ·å/å¯†ç 
   â†“
2. ç”Ÿæˆ JWT Token
   - Header: {"alg": "HS256", "typ": "JWT"}
   - Payload: {"user_id": 123, "uuid": "xxx", "exp": 1702300800}
   - Signature: HMAC-SHA256(base64(header) + "." + base64(payload), secret)
   â†“
3. è¿”å› Token ç»™å®¢æˆ·ç«¯
   â†“
4. å®¢æˆ·ç«¯åœ¨åç»­è¯·æ±‚ä¸­æºå¸¦ Token
   - Header: Authorization: Bearer {token}
   â†“
5. ä¸­é—´ä»¶éªŒè¯ Token
   - æ£€æŸ¥ç­¾åæ˜¯å¦æœ‰æ•ˆ
   - æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
   - æå– user_id åˆ° Context
   â†“
6. Handler ä» Context è·å– user_id
```

#### 8.1.2 æƒé™æ£€æŸ¥

**èµ„æºæ‰€æœ‰æƒæ£€æŸ¥**ï¼š
```go
// ç¤ºä¾‹ï¼šåˆ é™¤åº”ç”¨
func (s *AppService) DeleteApp(appID, userID uint) error {
    app, _ := s.repo.GetAppByID(appID)

    // æ£€æŸ¥èµ„æºæ˜¯å¦å±äºå½“å‰ç”¨æˆ·
    if app.UserID != userID {
        return errcode.New(errcode.ErrForbidden)
    }

    // æ‰§è¡Œåˆ é™¤
    ...
}
```

### 8.2 è¾“å…¥éªŒè¯

**å‚æ•°æ ¡éªŒ**ï¼ˆä½¿ç”¨ Gin çš„ bindingï¼‰ï¼š
```go
type RegisterRequest struct {
    Username string `json:"username" binding:"required,min=3,max=20"`
    Password string `json:"password" binding:"required,min=6,max=30"`
    Email    string `json:"email" binding:"required,email"`
}
```

**é˜²æ­¢æ³¨å…¥æ”»å‡»**ï¼š
- SQL æ³¨å…¥ï¼šä½¿ç”¨ GORM çš„å‚æ•°åŒ–æŸ¥è¯¢
- XSSï¼šå‰ç«¯å¯¹ç”¨æˆ·è¾“å…¥è¿›è¡Œè½¬ä¹‰
- CSRFï¼šä½¿ç”¨ Token éªŒè¯

### 8.3 å®‰å…¨é…ç½®

#### 8.3.1 JWT Secret ç®¡ç†

**å¼€å‘ç¯å¢ƒ**ï¼š
```yaml
# configs/config.yaml
jwt:
  secret: "astro-secret-key"  # å›ºå®šå€¼ï¼Œæ–¹ä¾¿å¼€å‘
  expire: "24h"
```

**ç”Ÿäº§ç¯å¢ƒ**ï¼š
```yaml
# ä½¿ç”¨ K8s Secret
apiVersion: v1
kind: Secret
metadata:
  name: jwt-secret
  namespace: astro-system
type: Opaque
data:
  secret: <base64ç¼–ç çš„éšæœºå­—ç¬¦ä¸²>
```

```go
// ä»ç¯å¢ƒå˜é‡è¯»å–
jwtSecret := os.Getenv("JWT_SECRET")
if jwtSecret == "" {
    jwtSecret = config.GlobalConfig.JWT.Secret
}
```

#### 8.3.2 æ•°æ®åº“å¯†ç ç®¡ç†

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: db-secret
  namespace: astro-system
type: Opaque
stringData:
  username: astro
  password: <ç”Ÿæˆçš„å¼ºå¯†ç >
  root-password: <ç”Ÿæˆçš„å¼ºå¯†ç >
```

### 8.4 ç½‘ç»œå®‰å…¨

#### 8.4.1 ç½‘ç»œç­–ç•¥

```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: astro-api-network-policy
  namespace: astro-system
spec:
  podSelector:
    matchLabels:
      app: astro-api
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # åªå…è®¸ Ingress Controller è®¿é—®
  - from:
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
    ports:
    - protocol: TCP
      port: 8080
  egress:
  # å…è®¸è®¿é—®æ•°æ®åº“
  - to:
    - podSelector:
        matchLabels:
          app: mariadb
    ports:
    - protocol: TCP
      port: 3306
  # å…è®¸è®¿é—® K8s API Server
  - to:
    - namespaceSelector: {}
      podSelector: {}
    ports:
    - protocol: TCP
      port: 443
```

#### 8.4.2 å¤šç§Ÿæˆ·ç½‘ç»œéš”ç¦»

```yaml
# æ¯ä¸ªç”¨æˆ·çš„å‘½åç©ºé—´éƒ½æœ‰ç‹¬ç«‹çš„ç½‘ç»œç­–ç•¥
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-all
  namespace: astro-user-123
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-same-namespace
  namespace: astro-user-123
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - podSelector: {}
  egress:
  - to:
    - podSelector: {}
```

---

## 9. ç›‘æ§ä¸è¿ç»´

### 9.1 æ—¥å¿—è®¾è®¡

#### 9.1.1 æ—¥å¿—çº§åˆ«

| çº§åˆ« | ä½¿ç”¨åœºæ™¯ | ç¤ºä¾‹ |
|-----|---------|------|
| Debug | è°ƒè¯•ä¿¡æ¯ | `logger.Debug("æŸ¥è¯¢ç”¨æˆ·", zap.String("username", "john"))` |
| Info | å¸¸è§„æ“ä½œ | `logger.Info("ç”¨æˆ·ç™»å½•æˆåŠŸ", zap.Uint("user_id", 123))` |
| Warn | å¼‚å¸¸ä½†å¯å¤„ç† | `logger.Warn("K8så®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥", zap.Error(err))` |
| Error | é”™è¯¯éœ€è¦å…³æ³¨ | `logger.Error("åˆ›å»ºåº”ç”¨å¤±è´¥", zap.Uint("app_id", 1), zap.Error(err))` |
| Fatal | è‡´å‘½é”™è¯¯é€€å‡º | `logger.Fatal("æ•°æ®åº“è¿æ¥å¤±è´¥", zap.Error(err))` |

#### 9.1.2 ç»“æ„åŒ–æ—¥å¿—

**å¥½çš„æ—¥å¿—ç¤ºä¾‹**ï¼š
```go
logger.Info("åˆ›å»ºåº”ç”¨",
    zap.Uint("user_id", req.UserID),
    zap.String("app_name", req.Name),
    zap.String("image", req.Image),
    zap.Int("replicas", req.Replicas),
)
```

**è¾“å‡º**ï¼š
```json
{
  "level": "info",
  "time": "2025-12-11T10:00:00+08:00",
  "caller": "service/app.go:123",
  "msg": "åˆ›å»ºåº”ç”¨",
  "user_id": 123,
  "app_name": "my-nginx",
  "image": "nginx:latest",
  "replicas": 2
}
```

#### 9.1.3 æ—¥å¿—è½®è½¬

```yaml
# configs/config.yaml
log:
  level: info               # ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ info
  file: logs/astro.log
  max_size: 100             # å•æ–‡ä»¶æœ€å¤§ 100MB
  max_backups: 10           # ä¿ç•™ 10 ä¸ªå†å²æ–‡ä»¶
  max_age: 30               # ä¿ç•™ 30 å¤©
  compress: true            # å¯ç”¨å‹ç¼©
```

### 9.2 ç›‘æ§æŒ‡æ ‡

#### 9.2.1 ä¸šåŠ¡æŒ‡æ ‡

| æŒ‡æ ‡ | è¯´æ˜ | ç›‘æ§æ–¹å¼ |
|-----|------|---------|
| ç”¨æˆ·æ€»æ•° | æ³¨å†Œç”¨æˆ·æ•°é‡ | æŸ¥è¯¢æ•°æ®åº“ |
| æ´»è·ƒç”¨æˆ·æ•° | æœ€è¿‘ 7 å¤©ç™»å½• | æŸ¥è¯¢æ•°æ®åº“ |
| åº”ç”¨æ€»æ•° | æ‰€æœ‰åº”ç”¨æ•°é‡ | æŸ¥è¯¢æ•°æ®åº“ |
| è¿è¡Œä¸­åº”ç”¨æ•° | status=running | æŸ¥è¯¢æ•°æ®åº“ |
| Pod æ€»æ•° | æ‰€æœ‰ Pod æ•°é‡ | K8s API |

#### 9.2.2 æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | è¯´æ˜ | å‘Šè­¦é˜ˆå€¼ |
|-----|------|---------|
| API å“åº”æ—¶é—´ | P50/P95/P99 | P95 > 1s |
| API é”™è¯¯ç‡ | 5xx é”™è¯¯å æ¯” | > 1% |
| æ•°æ®åº“è¿æ¥æ•° | æ´»è·ƒè¿æ¥æ•° | > 80% |
| æ•°æ®åº“æ…¢æŸ¥è¯¢ | > 1s çš„æŸ¥è¯¢ | > 10 æ¬¡/åˆ†é’Ÿ |
| K8s API è°ƒç”¨å»¶è¿Ÿ | è°ƒç”¨è€—æ—¶ | > 500ms |

### 9.3 å¥åº·æ£€æŸ¥

#### 9.3.1 Liveness Probeï¼ˆå­˜æ´»æ¢é’ˆï¼‰

```yaml
livenessProbe:
  httpGet:
    path: /health
    port: 8080
  initialDelaySeconds: 10
  periodSeconds: 10
  failureThreshold: 3
```

**å¥åº·æ£€æŸ¥æ¥å£**ï¼š
```go
// ç®€å•æ£€æŸ¥ï¼ˆæœåŠ¡æ˜¯å¦å­˜æ´»ï¼‰
r.GET("/health", func(c *gin.Context) {
    c.JSON(200, gin.H{"status": "ok"})
})
```

#### 9.3.2 Readiness Probeï¼ˆå°±ç»ªæ¢é’ˆï¼‰

```yaml
readinessProbe:
  httpGet:
    path: /ready
    port: 8080
  initialDelaySeconds: 5
  periodSeconds: 5
  failureThreshold: 3
```

**å°±ç»ªæ£€æŸ¥æ¥å£**ï¼š
```go
// æ·±åº¦æ£€æŸ¥ï¼ˆæ•°æ®åº“/K8s æ˜¯å¦å¯ç”¨ï¼‰
r.GET("/ready", func(c *gin.Context) {
    // æ£€æŸ¥æ•°æ®åº“è¿æ¥
    if err := repository.DB.Ping(); err != nil {
        c.JSON(503, gin.H{"status": "db_unavailable"})
        return
    }

    // æ£€æŸ¥ K8s è¿æ¥ï¼ˆå¯é€‰ï¼‰
    if !k8s.IsAvailable() {
        c.JSON(503, gin.H{"status": "k8s_unavailable"})
        return
    }

    c.JSON(200, gin.H{"status": "ready"})
})
```

### 9.4 è¿ç»´å‘½ä»¤

#### 9.4.1 æŸ¥çœ‹æ—¥å¿—

```bash
# æŸ¥çœ‹ API æ—¥å¿—
kubectl logs -f -n astro-system deployment/astro-api

# æŸ¥çœ‹æœ€è¿‘ 100 è¡Œ
kubectl logs -n astro-system deployment/astro-api --tail=100

# æŸ¥çœ‹æ‰€æœ‰ Pod çš„æ—¥å¿—
kubectl logs -n astro-system -l app=astro-api --all-containers=true
```

#### 9.4.2 æ‰©å®¹ç¼©å®¹

```bash
# æ‰©å®¹åˆ° 5 ä¸ªå‰¯æœ¬
kubectl scale deployment astro-api -n astro-system --replicas=5

# æŸ¥çœ‹ HPA çŠ¶æ€
kubectl get hpa -n astro-system
```

#### 9.4.3 æ»šåŠ¨æ›´æ–°

```bash
# æ›´æ–°é•œåƒ
kubectl set image deployment/astro-api astro-api=astro/api:v1.1.0 -n astro-system

# æŸ¥çœ‹æ›´æ–°çŠ¶æ€
kubectl rollout status deployment/astro-api -n astro-system

# å›æ»šåˆ°ä¸Šä¸€ç‰ˆæœ¬
kubectl rollout undo deployment/astro-api -n astro-system
```

---

## 10. é£é™©ä¸æŒ‘æˆ˜

### 10.1 æŠ€æœ¯é£é™©

| é£é™© | å½±å“ | æ¦‚ç‡ | åº”å¯¹æªæ–½ |
|-----|------|-----|---------|
| K8s é›†ç¾¤ä¸ç¨³å®š | åº”ç”¨åˆ›å»ºå¤±è´¥ | ä¸­ | å¢åŠ é‡è¯•æœºåˆ¶ï¼Œä¼˜é›…é™çº§ |
| æ•°æ®åº“æ€§èƒ½ç“¶é¢ˆ | å“åº”å˜æ…¢ | ä¸­ | è¯»å†™åˆ†ç¦»ï¼Œç¼“å­˜çƒ­ç‚¹æ•°æ® |
| ç”¨æˆ·åº”ç”¨è€—å°½é›†ç¾¤èµ„æº | å½±å“å…¶ä»–ç”¨æˆ· | é«˜ | èµ„æºé…é¢ï¼ˆResourceQuotaï¼‰ |
| æ¶æ„ç”¨æˆ·åˆ›å»ºå¤§é‡åº”ç”¨ | èµ„æºæµªè´¹ | ä¸­ | é™åˆ¶å•ç”¨æˆ·åº”ç”¨æ•°é‡ |
| æ—¥å¿—æ–‡ä»¶å æ»¡ç£ç›˜ | æœåŠ¡å´©æºƒ | ä½ | æ—¥å¿—è½®è½¬ï¼Œå®šæœŸæ¸…ç† |

### 10.2 å®‰å…¨é£é™©

| é£é™© | å½±å“ | æ¦‚ç‡ | åº”å¯¹æªæ–½ |
|-----|------|-----|---------|
| JWT Secret æ³„éœ² | ç”¨æˆ·èº«ä»½ä¼ªé€  | ä½ | ä½¿ç”¨ K8s Secretï¼Œå®šæœŸè½®æ¢ |
| SQL æ³¨å…¥ | æ•°æ®æ³„éœ² | ä½ | ä½¿ç”¨ ORM å‚æ•°åŒ–æŸ¥è¯¢ |
| XSS æ”»å‡» | ç”¨æˆ·ä¿¡æ¯æ³„éœ² | ä¸­ | å‰ç«¯è¾“å…¥è½¬ä¹‰ |
| ç”¨æˆ·è·¨ç§Ÿæˆ·è®¿é—® | æ•°æ®æ³„éœ² | ä¸­ | ä¸¥æ ¼çš„æƒé™æ£€æŸ¥ |
| æ¶æ„é•œåƒ | æŒ–çŸ¿ã€æ”»å‡» | é«˜ | é•œåƒç™½åå•ï¼Œå®‰å…¨æ‰«æ |

### 10.3 ä¸šåŠ¡é£é™©

| é£é™© | å½±å“ | æ¦‚ç‡ | åº”å¯¹æªæ–½ |
|-----|------|-----|---------|
| ç”¨æˆ·éƒ¨ç½²æŒ–çŸ¿ç¨‹åº | èµ„æºæµªè´¹ï¼Œæˆæœ¬å¢åŠ  | é«˜ | CPU é™é¢ï¼Œå¼‚å¸¸æ£€æµ‹ |
| ç”¨æˆ·åº”ç”¨å ç”¨è¿‡å¤šå†…å­˜ | OOMï¼Œå½±å“å…¶ä»–åº”ç”¨ | ä¸­ | å†…å­˜é™é¢ï¼Œè‡ªåŠ¨é‡å¯ |
| ç”¨æˆ·åº”ç”¨é—´äº’ç›¸è®¿é—® | æ•°æ®æ³„éœ² | ä¸­ | ç½‘ç»œç­–ç•¥éš”ç¦» |
| ç”¨æˆ·åˆ é™¤åº”ç”¨åæ•°æ®æ¢å¤ | ç”¨æˆ·æŠ•è¯‰ | ä½ | è½¯åˆ é™¤ï¼Œä¿ç•™æ•°æ® 7 å¤© |

### 10.4 å¯æ‰©å±•æ€§æŒ‘æˆ˜

| æŒ‘æˆ˜ | åœºæ™¯ | è§£å†³æ–¹æ¡ˆ |
|-----|------|---------|
| å•ä¸ª K8s é›†ç¾¤èµ„æºä¸è¶³ | ç”¨æˆ·é‡ > 1000 | å¤šé›†ç¾¤ç®¡ç†ï¼Œæ™ºèƒ½è°ƒåº¦ |
| çŠ¶æ€åŒæ­¥å»¶è¿Ÿ | åº”ç”¨åˆ—è¡¨åˆ·æ–°æ…¢ | å¼•å…¥ K8s Informer |
| æ•°æ®åº“å†™å…¥ç“¶é¢ˆ | é«˜å¹¶å‘åˆ›å»ºåº”ç”¨ | åˆ†åº“åˆ†è¡¨ï¼Œå¼‚æ­¥å†™å…¥ |
| åº”ç”¨æ—¥å¿—æŸ¥è¯¢æ…¢ | æ—¥å¿—é‡è¿‡å¤§ | å¼•å…¥ ELK æˆ– Loki |

---

## é™„å½•

### A. æœ¯è¯­è¡¨

| æœ¯è¯­ | å…¨ç§° | è§£é‡Š |
|-----|------|-----|
| CaaS | Container as a Service | å®¹å™¨å³æœåŠ¡ |
| K8s | Kubernetes | å®¹å™¨ç¼–æ’å¹³å° |
| CRD | Custom Resource Definition | è‡ªå®šä¹‰èµ„æºå®šä¹‰ |
| JWT | JSON Web Token | æ— çŠ¶æ€è®¤è¯ä»¤ç‰Œ |
| RBAC | Role-Based Access Control | åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ |
| HPA | Horizontal Pod Autoscaler | æ°´å¹³ Pod è‡ªåŠ¨æ‰©ç¼©å®¹ |
| ORM | Object-Relational Mapping | å¯¹è±¡å…³ç³»æ˜ å°„ |

### B. å‚è€ƒæ–‡æ¡£

- [Kubernetes å®˜æ–¹æ–‡æ¡£](https://kubernetes.io/docs/)
- [client-go æ–‡æ¡£](https://pkg.go.dev/k8s.io/client-go)
- [Gin æ¡†æ¶æ–‡æ¡£](https://gin-gonic.com/docs/)
- [GORM æ–‡æ¡£](https://gorm.io/docs/)
- [JWT è§„èŒƒ](https://jwt.io/introduction)

### C. ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | ä½œè€… | å˜æ›´è¯´æ˜ |
|-----|------|------|---------|
| v1.0 | 2025-12-11 | Claude | åˆå§‹ç‰ˆæœ¬ |

---

**æ–‡æ¡£ç»“æŸ**
